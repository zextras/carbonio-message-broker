pkgname="carbonio-message-broker"
pkgver="0.1.2"
pkgrel="1"
pkgdesc="Carbonio message broker"
pkgdesclong=(
  "Carbonio message broker"
)
url="https://www.zextras.com/"
maintainer="Zextras <packages@zextras.com>"
arch="all"
license=("MPL")
section="utils"
priority="optional"
depends:apt=(
  "adduser"
  "carbonio-erlang"
  "carbonio-openssl"
  "locales-all"
  "logrotate"
  "lsb-base"
  "pending-setups"
  "python3"
  "service-discover"
  "socat"
)
makedepends:apt=(
  "carbonio-elixir"
  "carbonio-erlang"
  "carbonio-openssl"
  "python3"
)
depends:yum=(
  "carbonio-erlang"
  "carbonio-openssl"
  "pending-setups"
  "python3"
  "service-discover"
  "socat"
)
makedepends:yum=(
  "carbonio-elixir"
  "carbonio-erlang"
  "carbonio-openssl"
  "python3"
)
sources=(
  "https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.10.25/rabbitmq-server-3.10.25.tar.xz"
  "carbonio-customizations.patch"
  "${pkgname}"
  "${pkgname}-set-admin"
  "${pkgname}-set-user"
  "${pkgname}-setup.sh"
  "${pkgname}-sidecar.service"
  "${pkgname}.hcl"
  "${pkgname}.logrotate"
  "${pkgname}.service"
  "${pkgname}.sysusers"
  "${pkgname}.tmpfiles"
  "default_schema.json"
  "enabled_plugins"
  "intentions.json"
  "policies.json"
  "rabbitmq-env.conf"
  "rabbitmq.conf"
  "service-protocol.json"
)
backup=(
  "/etc/carbonio/message-broker/enabled_plugins"
  "/etc/carbonio/message-broker/rabbitmq-env.conf"
  "/etc/carbonio/message-broker/conf.d/rabbitmq.conf"
  "/etc/zextras/service-discover/${pkgname}.hcl"
)
hashsums=(
  "skip"
  "4a9b2343edf855bcc3417b6beea2b2b4a7b139305e6ab321dec6e7aae5acc020"
  "b2d7fdb371140f5a73321c55b91103a0efad24ee7fbbeba7ec6417d160b6805b"
  "7840725dc3d490d3ff7610ea176db9025df084f3adfecf6cf6bbadf22f56a7f1"
  "1567bf5c63c5d01c8c58d33e1c3f05ec3068d64f96aff3147b7a9afaff7ab79a"
  "ba28e32af8b7f7434ca4cad4e06b59a29eda590a2295081753bb1eaaadb0cfa6"
  "21f04e61e8bd116ccdfcf16745855bae3f3e9e3b91c34a64e30e3308589d703a"
  "264477a1737dd47416e35452c43a0972e422ace5ea2b8641823e9978afd536a2"
  "98f8984a2bbdc98718c0997fbeb891a96caf69363da550d8302aad9615b03b0f"
  "f3d8206edfcb1a8ba815060b0099bb132304813ba953a5866456fe7633746523"
  "4ec3384cb0711ab84c563c15a5733a8018c671831a8728eb0d69f0353075eac0"
  "747e02b96333eaa47bd33fb9d5d1a626cbda584021a2a9331ad37d7fdde487d0"
  "75de905d307ddc252a348cae928bcb0a4e5af4ae51c9bb300741c413a8895050"
  "a52b2310ed0ebbec2c857c1b9ca6e50c8de672c9f2cbcd33df92a534c2683037"
  "fca7d97b628bb1a1b394f48adbb952cc5a5eefd1ae2be5e51bad3c062da7b02f"
  "5dbf5efa5179e115d8bbb88d31f8630247594fde945a9c4699a3fdc998d7350e"
  "070dd68fd7844f77db6f7bf470c59a66300b2d2ea920eaf25382e7b7a7c5d9c2"
  "6992e75cf19e260751db05fb6baabb851fac66219b307986ed76527036f7eddd"
  "a17e76860ec0ed475e08de55938e6e123a88528a05d6b758d4cdcc34f7f90e33"
)

build() {
  export PATH="/opt/zextras/common/bin/:$PATH"
  export LDFLAGS="-Wl,-rpath,/opt/zextras/common/lib -L/opt/zextras/common/lib"
  export CFLAGS="-I/opt/zextras/common/include"

  cd "${srcdir}"/rabbitmq-server-3.10.25
  patch -Np1 -i ../carbonio-customizations.patch

  make \
    PREFIX=/opt/zextras/common \
    RMQ_ROOTDIR=/opt/zextras/common/lib/rabbitmq
}

package() {
  export PATH="/opt/zextras/common/bin/:$PATH"
  export LDFLAGS="-Wl,-rpath,/opt/zextras/common/lib -L/opt/zextras/common/lib"
  export CFLAGS="-I/opt/zextras/common/include"

  cd "${srcdir}"/rabbitmq-server-3.10.25

  make \
    DESTDIR="${pkgdir}" \
    PREFIX=/opt/zextras/common \
    RMQ_ROOTDIR=/opt/zextras/common/lib/rabbitmq \
    install install-bin

  # using script wrapper for better bin handling
  libdir="${pkgdir}/opt/zextras/common/lib/rabbitmq/lib/rabbitmq_server-3.10.25"
  install -d "${pkgdir}/opt/zextras/common/bin"
  install -Dm 755 scripts/rabbitmq-script-wrapper \
    -t "${pkgdir}/opt/zextras/common/lib/rabbitmq/bin"
  for script in "${libdir}"/sbin/rabbit*; do
    ln -s /opt/zextras/common/lib/rabbitmq/bin/rabbitmq-script-wrapper \
      "${pkgdir}/opt/zextras/common/bin/${script#${libdir}/sbin/}"
  done

  install -Dm644 "${srcdir}/rabbitmq-env.conf" \
    "${pkgdir}/etc/carbonio/message-broker/rabbitmq-env.conf"
  install -Dm644 "${srcdir}/rabbitmq.conf" \
    "${pkgdir}/etc/carbonio/message-broker/conf.d/rabbitmq.conf"
  install -Dm644 "${srcdir}/default_schema.json" \
    "${pkgdir}/etc/carbonio/message-broker/default_schema.json"
  install -Dm644 "${srcdir}/enabled_plugins" \
    "${pkgdir}/etc/carbonio/message-broker/enabled_plugins"
  install -Dm 644 "${srcdir}/${pkgname}.sysusers" \
    "${pkgdir}/usr/lib/sysusers.d/${pkgname}.conf"
  install -Dm644 "${srcdir}/${pkgname}.tmpfiles" \
    "${pkgdir}/usr/lib/tmpfiles.d/${pkgname}.conf"
  install -Dm644 "${srcdir}/${pkgname}.logrotate" \
    "${pkgdir}/etc/logrotate.d/${pkgname}"

  cd ${srcdir}
  install -Dm644 intentions.json \
    "${pkgdir}/etc/carbonio/message-broker/service-discover/intentions.json"
  install -Dm644 policies.json \
    "${pkgdir}/etc/carbonio/message-broker/service-discover/policies.json"
  install -Dm644 service-protocol.json \
    "${pkgdir}/etc/carbonio/message-broker/service-discover/service-protocol.json"
  install -Dm644 ${pkgname}.hcl \
    "${pkgdir}/etc/zextras/service-discover/${pkgname}.hcl"
  install -Dm644 ${pkgname}.service \
    "${pkgdir}/lib/systemd/system/${pkgname}.service"
  install -Dm644 ${pkgname}-sidecar.service \
    "${pkgdir}/lib/systemd/system/${pkgname}-sidecar.service"
  install -Dm644 ${pkgname}-setup.sh \
    "${pkgdir}/etc/zextras/pending-setups.d/${pkgname}.sh"
  install -Dm755 ${pkgname} \
    "${pkgdir}/usr/bin/${pkgname}"
  install -Dm755 ${pkgname}-set-user \
    "${pkgdir}/usr/bin/${pkgname}-set-user"
  install -Dm755 ${pkgname}-set-admin \
    "${pkgdir}/usr/bin/${pkgname}-set-admin"

  # Create log folder for carbonio-message-broker
  install -d "${pkgdir}/var/log/carbonio/message-broker"
}

postinst() {
  getent group 'carbonio-message-broker' >/dev/null ||
    groupadd -r 'carbonio-message-broker'
  getent passwd 'carbonio-message-broker' >/dev/null ||
    useradd -r -m -g 'carbonio-message-broker' -d /var/lib/carbonio-message-broker -s /sbin/nologin 'carbonio-message-broker'

  if [ -d /run/systemd/system ]; then
    systemctl daemon-reload >/dev/null 2>&1 || :
    systemctl enable carbonio-message-broker.service >/dev/null 2>&1 || :
    systemctl enable carbonio-message-broker-sidecar.service >/dev/null 2>&1 || :
  fi

  chown -R carbonio-message-broker:carbonio-message-broker /etc/carbonio/message-broker
  chown -R carbonio-message-broker:carbonio-message-broker /var/lib/carbonio-message-broker
  chown -R carbonio-message-broker:carbonio-message-broker /var/lib/carbonio-message-broker
  chown -R carbonio-message-broker:carbonio-message-broker /var/log/carbonio/message-broker

  echo "======================================================"
  echo "Carbonio message broker installed successfully!"
  echo "You must run pending-setups to configure it correctly."
  echo "======================================================"
}

prerm() {
  if [ -d /run/systemd/system ]; then
    systemctl --no-reload disable carbonio-message-broker.service >/dev/null 2>&1 || :
    systemctl --no-reload disable carbonio-message-broker-sidecar.service >/dev/null 2>&1 || :
    systemctl stop carbonio-message-broker.service >/dev/null 2>&1 || :
    systemctl stop carbonio-message-broker-sidecar.service >/dev/null 2>&1 || :
  fi
}

postrm:apt() {
  if [ "$1" = "purge" ]; then
    rm -rf /var/lib/carbonio-message-broker/mnesia/
  fi

  rm -f /etc/carbonio/message-broker/service-discover/token
  if [ -d /run/systemd/system ]; then
    systemctl daemon-reload >/dev/null 2>&1 || :
  fi
}

postrm:yum() {
  rm -f /etc/carbonio/message-broker/service-discover/token
  if [ -d /run/systemd/system ]; then
    systemctl daemon-reload >/dev/null 2>&1 || :
  fi

  echo "Don't forget to backup/remove the following folder:"
  echo ""
  echo "/var/lib/carbonio-message-broker/mnesia/"
}
