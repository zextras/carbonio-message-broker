pkgname="carbonio-message-broker"
pkgver="0.1.0"
pkgrel="1"
pkgdesc="Carbonio message broker"
pkgdesclong=(
  "Carbonio message broker"
)
url="https://www.zextras.com/"
maintainer="Zextras <packages@zextras.com>"
arch="all"
license=("MPL")
section="utils"
priority="optional"
depends:apt=(
  "adduser"
  "carbonio-erlang"
  "carbonio-openssl"
  "locales-all"
  "logrotate"
  "lsb-base"
  "pending-setups"
  "python3"
  "service-discover"
  "socat"
)
makedepends:apt=(
  "carbonio-elixir"
  "carbonio-erlang"
  "carbonio-openssl"
  "python3"
)
depends:yum=(
  "carbonio-erlang"
  "carbonio-openssl"
  "pending-setups"
  "python3"
  "service-discover"
  "socat"
)
makedepends:yum=(
  "carbonio-elixir"
  "carbonio-erlang"
  "carbonio-openssl"
  "python3"
)
sources=(
  "https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.10.7/rabbitmq-server-3.10.7.tar.xz"
  "carbonio-customizations.patch"
  "${pkgname}"
  "${pkgname}-set-admin"
  "${pkgname}-set-user"
  "${pkgname}-setup.sh"
  "${pkgname}-sidecar.service"
  "${pkgname}.hcl"
  "${pkgname}.logrotate"
  "${pkgname}.service"
  "${pkgname}.sysusers"
  "${pkgname}.tmpfiles"
  "default_schema.json"
  "enabled_plugins"
  "intentions.json"
  "policies.json"
  "rabbitmq-env.conf"
  "rabbitmq.conf"
  "service-protocol.json"
)
backup=(
  "/etc/carbonio/message-broker/enabled_plugins"
  "/etc/carbonio/message-broker/rabbitmq-env.conf"
  "/etc/carbonio/message-broker/conf.d/rabbitmq.conf"
  "/etc/zextras/service-discover/${pkgname}.hcl"
)
hashsums=(
  "b55e30584187f196505053db1fe90601eac7c9063415fff80db06c247d692eb5"
  "skip"
  "skip"
  "skip"
  "skip"
  "skip"
  "skip"
  "skip"
  "skip"
  "skip"
  "skip"
  "skip"
  "skip"
  "skip"
  "skip"
  "skip"
  "skip"
  "skip"
  "skip"
)

build() {
  export PATH="/opt/zextras/common/bin/:$PATH"
  export LDFLAGS="-Wl,-rpath,/opt/zextras/common/lib -L/opt/zextras/common/lib"
  export CFLAGS="-I/opt/zextras/common/include"

  cd "${srcdir}"/rabbitmq-server-3.10.7
  patch -Np1 -i ../carbonio-customizations.patch

  make \
    PREFIX=/opt/zextras/common \
    RMQ_ROOTDIR=/opt/zextras/common/lib/rabbitmq
}

package() {
  export PATH="/opt/zextras/common/bin/:$PATH"
  export LDFLAGS="-Wl,-rpath,/opt/zextras/common/lib -L/opt/zextras/common/lib"
  export CFLAGS="-I/opt/zextras/common/include"

  cd "${srcdir}"/rabbitmq-server-3.10.7

  make \
    DESTDIR="${pkgdir}" \
    PREFIX=/opt/zextras/common \
    RMQ_ROOTDIR=/opt/zextras/common/lib/rabbitmq \
    install install-bin

  # using script wrapper for better bin handling
  libdir="${pkgdir}/opt/zextras/common/lib/rabbitmq/lib/rabbitmq_server-3.10.7"
  install -d "${pkgdir}/opt/zextras/common/bin"
  install -Dm 755 scripts/rabbitmq-script-wrapper \
    -t "${pkgdir}/opt/zextras/common/lib/rabbitmq/bin"
  for script in "${libdir}"/sbin/rabbit*; do
    ln -s /opt/zextras/common/lib/rabbitmq/bin/rabbitmq-script-wrapper \
      "${pkgdir}/opt/zextras/common/bin/${script#${libdir}/sbin/}"
  done

  install -Dm644 "${srcdir}/rabbitmq-env.conf" \
    "${pkgdir}/etc/carbonio/message-broker/rabbitmq-env.conf"
  install -Dm644 "${srcdir}/rabbitmq.conf" \
    "${pkgdir}/etc/carbonio/message-broker/conf.d/rabbitmq.conf"
  install -Dm644 "${srcdir}/default_schema.json" \
    "${pkgdir}/etc/carbonio/message-broker/default_schema.json"
  install -Dm644 "${srcdir}/enabled_plugins" \
    "${pkgdir}/etc/carbonio/message-broker/enabled_plugins"
  install -Dm 644 "${srcdir}/${pkgname}.sysusers" \
    "${pkgdir}/usr/lib/sysusers.d/${pkgname}.conf"
  install -Dm644 "${srcdir}/${pkgname}.tmpfiles" \
    "${pkgdir}/usr/lib/tmpfiles.d/${pkgname}.conf"
  install -Dm644 "${srcdir}/${pkgname}.logrotate" \
    "${pkgdir}/etc/logrotate.d/${pkgname}"

  cd ${srcdir}
  install -Dm644 intentions.json \
    "${pkgdir}/etc/carbonio/message-broker/service-discover/intentions.json"
  install -Dm644 policies.json \
    "${pkgdir}/etc/carbonio/message-broker/service-discover/policies.json"
  install -Dm644 service-protocol.json \
    "${pkgdir}/etc/carbonio/message-broker/service-discover/service-protocol.json"
  install -Dm644 ${pkgname}.hcl \
    "${pkgdir}/etc/zextras/service-discover/${pkgname}.hcl"
  install -Dm644 ${pkgname}.service \
    "${pkgdir}/lib/systemd/system/${pkgname}.service"
  install -Dm644 ${pkgname}-sidecar.service \
    "${pkgdir}/lib/systemd/system/${pkgname}-sidecar.service"
  install -Dm644 ${pkgname}-setup.sh \
    "${pkgdir}/etc/zextras/pending-setups.d/${pkgname}.sh"
  install -Dm755 ${pkgname} \
    "${pkgdir}/usr/bin/${pkgname}"
  install -Dm755 ${pkgname}-set-user \
    "${pkgdir}/usr/bin/${pkgname}-set-user"
  install -Dm755 ${pkgname}-set-admin \
    "${pkgdir}/usr/bin/${pkgname}-set-admin"

  # Create log folder for carbonio-message-broker  
  install -d "${pkgdir}/var/log/carbonio/message-broker"
}

postinst() {
  getent group 'carbonio-message-broker' >/dev/null ||
    groupadd -r 'carbonio-message-broker'
  getent passwd 'carbonio-message-broker' >/dev/null ||
    useradd -r -m -g 'carbonio-message-broker' -d /var/lib/carbonio-message-broker -s /sbin/nologin 'carbonio-message-broker'

  if [ -d /run/systemd/system ]; then
    systemctl daemon-reload >/dev/null 2>&1 || :
    systemctl enable carbonio-message-broker.service >/dev/null 2>&1 || :
    systemctl enable carbonio-message-broker-sidecar.service >/dev/null 2>&1 || :
  fi

  chown -R carbonio-message-broker:carbonio-message-broker /etc/carbonio/message-broker
  chown -R carbonio-message-broker:carbonio-message-broker /var/lib/carbonio-message-broker
  chown -R carbonio-message-broker:carbonio-message-broker /var/lib/carbonio-message-broker
  chown -R carbonio-message-broker:carbonio-message-broker /var/log/carbonio/message-broker

  echo "======================================================"
  echo "Carbonio message broker installed successfully!"
  echo "You must run pending-setups to configure it correctly."
  echo "======================================================"
}

prerm() {
  if [ -d /run/systemd/system ]; then
    systemctl --no-reload disable carbonio-message-broker.service >/dev/null 2>&1 || :
    systemctl --no-reload disable carbonio-message-broker-sidecar.service >/dev/null 2>&1 || :
    systemctl stop carbonio-message-broker.service >/dev/null 2>&1 || :
    systemctl stop carbonio-message-broker-sidecar.service >/dev/null 2>&1 || :
  fi
}

postrm:apt() {
  if [ "$1" = "purge" ]; then
    rm -rf /var/lib/carbonio-message-broker/mnesia/
  fi

  rm -f /etc/carbonio/message-broker/service-discover/token
  if [ -d /run/systemd/system ]; then
    systemctl daemon-reload >/dev/null 2>&1 || :
  fi
}

postrm:yum() {
  rm -f /etc/carbonio/message-broker/service-discover/token
  if [ -d /run/systemd/system ]; then
    systemctl daemon-reload >/dev/null 2>&1 || :
  fi

  echo "Don't forget to backup/remove the following folder:"
  echo ""
  echo "/var/lib/carbonio-message-broker/mnesia/"
}
