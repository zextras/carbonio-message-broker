pkgname="carbonio-message-broker"
pkgver="0.1.0"
pkgrel="1"
pkgdesc="Carbonio message broker"
pkgdesclong=(
  "Carbonio message broker"
)
url="https://www.zextras.com/"
maintainer="Zextras <packages@zextras.com>"
arch="all"
license=("MPL")
# backup=("etc/rabbitmq/rabbitmq-env.conf")
depends:apt=(
  "adduser"
  "carbonio-erlang"
  "jq"
  "locales-all"
  "logrotate"
  "lsb-base"
  "pending-setups"
  "python3"
  "service-discover"
  "socat"
)
makedepends:apt=(
  "inetutils-tools"
  "libxslt-dev"
  "python3"
  "python3-simplejson"
  "rsync"
  "socat"
  "systemd"
  "unzip"
  "util-linux"
  "xmlto"
  "zip"
)

sources=(
  "https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.10.1/rabbitmq-server-3.10.1.tar.xz"
)

hashsums=(
  "13712b9cc86beede0eccd19503480ad393d7d211133c864208b4384a62d34cfb"
)

build() {
  cd "${srcdir}"/rabbitmq-server-3.10.1
  sed -E 's|^(SYS_PREFIX=).*$|\1""|' -i deps/rabbit/scripts/rabbitmq-defaults
  sed -E 's|@RABBITMQ_USER@|carbonio-message-broker|g' -i scripts/rabbitmq-script-wrapper
  sed -E 's|@RABBITMQ_GROUP@|carbonio-message-broker|g' -i scripts/rabbitmq-script-wrapper
  sed -E 's|@STDOUT_STDERR_REDIRECTION@||g' -i scripts/rabbitmq-script-wrapper
  sed -e "s|%%VSN%%|3.10.1|" -i deps/rabbitmq_management/bin/rabbitmqadmin
  # patch -p1 <../rabbitmq-customize-systemd-service.patch

  grep -Rsnl "python" | xargs sed -i 's/python/python3/g'

  export LC_ALL=en_US.UTF-8
  
  make
  make DESTDIR="${pkgdir}" \
    PREFIX=/opt/zextras/common \
    RMQ_ROOTDIR=/opt/zextras/common/lib/rabbitmq \
    install

  # install -Dm 644 deps/rabbit/docs/rabbitmq-server.service.example "${pkgdir}/opt/zextras/common/lib/systemd/system/rabbitmq.service"
  # install -Dm 644 "${srcdir}/rabbitmq-env.conf" "${pkgdir}/etc/rabbitmq/rabbitmq-env.conf"
  # install -Dm 644 "${srcdir}/rabbitmq.sysusers" "${pkgdir}/opt/zextras/common/lib/sysusers.d/rabbitmq.conf"
  # install -Dm 644 "${srcdir}/rabbitmq.tmpfiles" "${pkgdir}/opt/zextras/common/lib/tmpfiles.d/rabbitmq.conf"
  # install -Dm 644 "${srcdir}/rabbitmq.logrotate" "${pkgdir}/etc/logrotate.d/rabbitmq"

  # chown -R 197:0 "${pkgdir}/etc/rabbitmq"

  cd "${srcdir}"/rabbitmq-server-3.10.1/deps/rabbitmq_management
  install -Dm 755 bin/rabbitmqadmin -t "${pkgdir}/opt/zextras/common/bin"

  # install -Dm 644 "${srcdir}"/intentions.json \
  #   "${pkgdir}/etc/carbonio/message-broker/service-discover/intentions.json"
  # install -Dm 644 "${srcdir}"/policies.json \
  #   "${pkgdir}/etc/carbonio/message-broker/service-discover/policies.json"
  # install -Dm 644 "${srcdir}"/service-protocol.json \
  #   "${pkgdir}/etc/carbonio/message-broker/service-discover/service-protocol.json"
}

postinst() {
  getent group 'carbonio-message-broker' >/dev/null ||
    groupadd -r 'carbonio-message-broker'
  getent passwd 'carbonio-message-broker' >/dev/null ||
    useradd -r -M -g 'carbonio-message-broker' -s /sbin/nologin 'carbonio-message-broker'

  if [ -d /run/systemd/system ]; then
    systemctl daemon-reload >/dev/null 2>&1 || :
    systemctl enable carbonio-message-broker.service >/dev/null 2>&1 || :
    systemctl enable carbonio-message-broker-sidecar.service >/dev/null 2>&1 || :
  fi

  echo "======================================================"
  echo "Carbonio message broker installed successfully!"
  echo "You must run pending-setups to configure it correctly."
  echo "======================================================"
}

prerm() {
  if [ -d /run/systemd/system ]; then
    systemctl --no-reload disable carbonio-message-broker.service >/dev/null 2>&1 || :
    systemctl --no-reload disable carbonio-message-broker-sidecar.service >/dev/null 2>&1 || :
    systemctl stop carbonio-message-broker.service >/dev/null 2>&1 || :
    systemctl stop carbonio-message-broker-sidecar.service >/dev/null 2>&1 || :
  fi
}

postrm() {
  rm -f /etc/carbonio/message-broker/service-discover/token
  if [ -d /run/systemd/system ]; then
    systemctl daemon-reload >/dev/null 2>&1 || :
  fi
}
