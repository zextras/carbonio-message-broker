pkgname="carbonio-erlang"
pkgver="24.3.2"
pkgrel="1"
pkgdesc="General-purpose concurrent functional programming language (headless version)"
pkgdesclong=(
  "General-purpose concurrent functional programming language (headless version)"
)
arch="amd64"
url="https://erlang.org/"
maintainer="Zextras <packages@zextras.com>"
license=("Apache")
depends:apt=(
  "carbonio-openssl"
  "libncursesw6"
)
makedepends:apt=(
  "carbonio-openssl"
  "fop"
  "git"
  "libncurses-dev"
  "libxslt1-dev"
  "lksctp-tools"
  "unixodbc"
  "util-linux-locales"
)
depends:yum=(
  "ncurses"
  "carbonio-openssl"
)
makedepends:yum=(
  "carbonio-openssl"
  "fop "
  "git"
  "libxslt-devel"
  "lksctp-tools"
  "ncurses-devel"
  "unixodbc"
)
sources=(
  "epmd.conf"
  "epmd.service"
  "epmd.socket"
  "https://github.com/erlang/otp/archive/7bd6e24d3dded3a393f9bb774ccf98cc0af4d595.tar.gz"
)
hashsums=(
  "1675ac9bf948ab19e8b63077d870ccf356fcdbce14de2777f00b3488aa1ce34a5e0a5cdc0428707f744dee5940b12653a44e0ded0554de95ebb31bce4676ff87"
  "1f765318bcd322ce697a48c064ccdb1bd107b4a84e164a87f62678391cb82a9ab17a397d679cf266e037a5a2d91772b85f7a97f9cc5478c0f18118743b30045f"
  "c37706f5f6e2d49100104fb442ebf15edd6ee0a1e8038d0364794cf34fd3f02a61b9ad2706228b3327b85b0cadcd11aac6087e7c98408eae2d307a09191b6553"
  "SKIP"
)

build() {
  cd "${srcdir}/otp-7bd6e24d3dded3a393f9bb774ccf98cc0af4d595"
  ./otp_build autoconf

  export LC_ALL=en_US.UTF-8
  
  ./configure \
    --enable-builtin-zlib \
    --enable-smp-support \
    --prefix=/opt/zextras/common \
    --with-odbc \
    --with-ssl=/opt/zextras/common
  make
}

package() {
  cd "${srcdir}"

  make -C otp-7bd6e24d3dded3a393f9bb774ccf98cc0af4d595 DESTDIR="${pkgdir}" install

  # services and configuration
  install -Dm644 epmd.service "${pkgdir}/usr/lib/systemd/system/epmd.service"
  install -Dm644 epmd.socket "${pkgdir}/usr/lib/systemd/system/epmd.socket"
  install -Dm644 epmd.conf "${pkgdir}/etc/conf.d/epmd"

  # remove files that are included in the erlang-unixodbc package
  rm -rf "${pkgdir}/opt/zextras/common/erlang/"{lib/odbc*,man/man3/odbc.3}
}